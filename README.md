# OCI Ampere Provisioning Script

This repo is intentionally beginner-friendly and uses a single entrypoint script:
- `run-a1.sh`

You run that one script for setup and provisioning:
- Setup mode: `./run-a1.sh --setup`
- Provision mode: `./run-a1.sh --config a1-spec.yaml`

## What this does

- Tries to provision `VM.Standard.A1.Flex` in OCI until capacity is available.
- Targets your requested config by default:
  - `4 OCPU`
  - `24 GB RAM`
  - `160 GB boot volume`
- Uses region from config (`us-ashburn-1` in default file).
- Creates/reuses required network resources.
- Stops once one managed A1 instance is active.

## Files

- `run-a1.sh`: only script you run directly
- `a1-spec.yaml`: editable config/spec
- `docs/API_KEY_SETUP.md`: detailed OCI API key walkthrough
- `docs/OPERATIONS.md`: troubleshooting and cleanup

## Step 1: First-time setup (beginners)

Run:

```bash
chmod +x run-a1.sh
./run-a1.sh --setup
```

Setup mode will:
- Check/install dependencies (`oci`, `jq`, `yq`, `ssh-keygen`)
- Create `a1-spec.yaml` if missing
- Create/reuse SSH keypair in this folder:
  - `./keys/ampere_a1_key`
  - `./keys/ampere_a1_key.pub`
- Launch `oci setup config` if `~/.oci/config` is not present

## Step 2: Configure OCI API key in Console

Follow the detailed guide in `docs/API_KEY_SETUP.md`.

Short version:
1. Open OCI Console.
2. Go to user settings and add an API key.
3. Upload the public key generated by OCI CLI setup (`oci setup config`) or your chosen API key public key.
4. Confirm `~/.oci/config` has your `user`, `fingerprint`, `tenancy`, `region`, and `key_file`.

## Step 3: Fill in your compartment

Edit `a1-spec.yaml` and set:
- `oci.compartment_ocid: "ocid1.compartment...."`

## Step 4: Start provisioning loop

```bash
./run-a1.sh --config a1-spec.yaml
```

## Optional flags

```bash
./run-a1.sh --config a1-spec.yaml --interval 60 --jitter 10
./run-a1.sh --config a1-spec.yaml --log-file ./a1-provision.log
./run-a1.sh --setup --yes
```

## Logging

- Console + log file (default `./a1-provision.log`)
- Useful events:
  - `AUTH_CHECK`
  - `NET_CREATE` / `NET_REUSE`
  - `LAUNCH_ATTEMPT`
  - `LAUNCH_RETRYABLE`
  - `LAUNCH_SUCCESS`
  - `ALREADY_ACTIVE`

## Important notes

- Networking resources are reused by display name.
- Managed resources use freeform tag `ManagedBy=A1RetryScript` (configurable).
- `--yes` disables prompts. In setup mode, interactive OCI config still requires running without `--yes`.
